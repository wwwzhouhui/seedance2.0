# Seedance 2.0 详细设计

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | Seedance 2.0 AI 视频生成 |
| 文档版本 | v1.0.0 |
| 创建日期 | 2026-02-13 |
| 文档状态 | 正式发布 |

## 2. 前端详细设计

### 2.1 App.tsx - 根组件

#### 2.1.1 组件职责

- 应用主入口，负责整体布局
- 管理全局状态
- 协调子组件交互

#### 2.1.2 状态定义

```typescript
// 图片列表状态
const [images, setImages] = useState<UploadedImage[]>([]);

// 提示词状态
const [prompt, setPrompt] = useState('');

// 画面比例状态
const [ratio, setRatio] = useState<AspectRatio>('16:9');

// 视频时长状态
const [duration, setDuration] = useState<Duration>(5);

// 参考模式状态
const [referenceMode, setReferenceMode] = useState<ReferenceMode>('全能参考');

// 生成状态
const [generation, setGeneration] = useState<GenerationState>({
  status: 'idle',
});

// 会话ID状态
const [sessionId, setSessionId] = useState('');

// 设置弹窗状态
const [showSettings, setShowSettings] = useState(false);
```

#### 2.1.3 核心函数

**addFiles - 添加图片文件**

```typescript
const addFiles = useCallback(
  (fileList: FileList | null) => {
    if (!fileList) return;
    const remaining = maxImages - images.length;
    if (remaining <= 0) return;

    const newFiles = Array.from(fileList).slice(0, remaining);
    const newImages: UploadedImage[] = newFiles.map((file, i) => ({
      id: `img-${++nextId}`,
      file,
      previewUrl: URL.createObjectURL(file),
      index: images.length + i + 1,
    }));

    setImages([...images, ...newImages]);
  },
  [images]
);
```

**removeImage - 移除单张图片**

```typescript
const removeImage = useCallback(
  (id: string) => {
    const removed = images.find((img) => img.id === id);
    if (removed) URL.revokeObjectURL(removed.previewUrl);

    const updated = images
      .filter((img) => img.id !== id)
      .map((img, i) => ({ ...img, index: i + 1 }));
    setImages(updated);
  },
  [images]
);
```

**handleGenerate - 触发视频生成**

```typescript
const handleGenerate = useCallback(async () => {
  if (!prompt.trim() && images.length === 0) return;
  if (generation.status === 'generating') return;

  setGeneration({
    status: 'generating',
    progress: '正在提交视频生成请求...',
  });

  try {
    const result = await generateVideo(
      {
        prompt,
        model: 'seedance-2.0',
        ratio,
        duration,
        files: images.map((img) => img.file),
        sessionId: sessionId || undefined,
      },
      (progress) => {
        setGeneration((prev) => ({ ...prev, progress }));
      }
    );

    if (result.data && result.data.length > 0 && result.data[0].url) {
      setGeneration({ status: 'success', result });
    } else {
      setGeneration({
        status: 'error',
        error: '未获取到视频结果，请重试',
      });
    }
  } catch (error) {
    setGeneration({
      status: 'error',
      error: error instanceof Error ? error.message : '未知错误',
    });
  }
}, [prompt, images, ratio, duration, sessionId, generation.status]);
```

#### 2.1.4 生命周期

```typescript
useEffect(() => {
  // 加载保存的设置
  const saved = loadSettings();
  if (saved.sessionId) setSessionId(saved.sessionId);

  // 检查是否需要显示设置弹窗
  const envSessionId = import.meta.env.VITE_DEFAULT_SESSION_ID;
  if (!saved.sessionId && !envSessionId) {
    setShowSettings(true);
  }
}, []);
```

### 2.2 videoService.ts - 视频生成服务

#### 2.2.1 generateVideo 函数

```typescript
export async function generateVideo(
  request: GenerateVideoRequest,
  onProgress?: (message: string) => void
): Promise<VideoGenerationResponse>
```

**处理流程：**

1. 构建 FormData 请求体
2. 调用 POST /api/generate-video 提交任务
3. 获取 taskId 后开始轮询
4. 每 3 秒查询一次任务状态
5. 最长等待 25 分钟
6. 返回视频结果或抛出错误

**轮询逻辑：**

```typescript
const maxPollTime = 25 * 60 * 1000; // 25 分钟
const pollInterval = 3000; // 3 秒
const startTime = Date.now();

while (Date.now() - startTime < maxPollTime) {
  await new Promise((resolve) => setTimeout(resolve, pollInterval));

  const pollRes = await fetch(`/api/task/${taskId}`);
  const pollData = await pollRes.json();

  if (pollData.status === 'done') {
    return pollData.result;
  }

  if (pollData.status === 'error') {
    throw new Error(pollData.error || '视频生成失败');
  }

  if (pollData.progress) {
    onProgress?.(pollData.progress);
  }
}

throw new Error('视频生成超时，请稍后重试');
```

### 2.3 VideoPlayer.tsx - 视频播放组件

#### 2.3.1 组件接口

```typescript
interface VideoPlayerProps {
  videoUrl: string | null;      // 视频URL
  revisedPrompt?: string;       // AI优化后的提示词
  isLoading: boolean;           // 是否加载中
  error?: string;               // 错误信息
  progress?: string;            // 进度描述
}
```

#### 2.3.2 渲染逻辑

```typescript
// 加载中状态
if (isLoading) {
  return (
    <div className="flex-1 flex flex-col items-center justify-center">
      <SpinnerIcon />
      <p>{progress || '正在生成视频...'}</p>
    </div>
  );
}

// 错误状态
if (error) {
  return (
    <div className="flex-1 flex flex-col items-center justify-center">
      <span>!</span>
      <p>{error}</p>
    </div>
  );
}

// 成功状态
if (videoUrl) {
  return (
    <div>
      <video controls src={proxyUrl(videoUrl)} autoPlay loop />
      <a href={proxied} download>下载视频</a>
    </div>
  );
}

// 空闲状态
return (
  <div className="flex-1 flex flex-col items-center justify-center opacity-50">
    <FilmIcon />
    <p>AI视频制作就绪</p>
  </div>
);
```

### 2.4 SettingsModal.tsx - 设置弹窗

#### 2.4.1 组件接口

```typescript
interface SettingsModalProps {
  isOpen: boolean;
  onClose: () => void;
  sessionId: string;
  onSessionIdChange: (id: string) => void;
}
```

#### 2.4.2 本地存储操作

```typescript
const LS_SESSION_KEY = 'seedance_session_id';

export function loadSettings() {
  return {
    sessionId: localStorage.getItem(LS_SESSION_KEY) || '',
  };
}

// 保存设置
const handleSave = () => {
  onSessionIdChange(localSessionId);
  localStorage.setItem(LS_SESSION_KEY, localSessionId);
  onClose();
};
```

### 2.5 Icons.tsx - 图标组件

**已实现图标：**

| 图标名 | 用途 |
|--------|------|
| GearIcon | 设置按钮 |
| PlusIcon | 添加图片 |
| CloseIcon | 关闭/删除 |
| SparkleIcon | 生成按钮 |
| SpinnerIcon | 加载动画 |
| FilmIcon | 空状态 |
| DownloadIcon | 下载按钮 |
| EyeIcon | 显示密码 |
| EyeOffIcon | 隐藏密码 |

## 3. 后端详细设计

### 3.1 server/index.js - 服务入口

#### 3.1.1 服务初始化

```javascript
import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import multer from 'multer';

const app = express();
const PORT = process.env.PORT || 3001;

// 中间件配置
app.use(cors());
app.use(express.json());

// 文件上传配置
const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 20 * 1024 * 1024 }, // 20MB
});
```

#### 3.1.2 任务管理器

```javascript
const tasks = new Map();
let taskCounter = 0;

function createTaskId() {
  return `task_${++taskCounter}_${Date.now()}`;
}

// 定期清理过期任务 (每分钟)
setInterval(() => {
  const now = Date.now();
  for (const [id, task] of tasks) {
    if (now - task.startTime > 30 * 60 * 1000) { // 30分钟过期
      tasks.delete(id);
    }
  }
}, 60000);
```

### 3.2 API 路由设计

#### 3.2.1 POST /api/generate-video

```javascript
app.post('/api/generate-video', upload.array('files', 5), async (req, res) => {
  const { prompt, ratio, duration, sessionId } = req.body;
  const files = req.files;

  // 1. 认证检查
  const authToken = sessionId || DEFAULT_SESSION_ID;
  if (!authToken) {
    return res.status(401).json({ error: '未配置 Session ID' });
  }

  // 2. 参数验证
  if (!Array.isArray(files) || files.length === 0) {
    return res.status(400).json({ error: '需要至少上传一张参考图片' });
  }

  // 3. 创建任务
  const taskId = createTaskId();
  const task = {
    id: taskId,
    status: 'processing',
    progress: '正在准备...',
    startTime: Date.now(),
    result: null,
    error: null,
  };
  tasks.set(taskId, task);

  // 4. 立即返回 taskId
  res.json({ taskId });

  // 5. 后台执行生成
  generateSeedanceVideo(taskId, { prompt, ratio, duration, files, sessionId: authToken })
    .then((videoUrl) => {
      task.status = 'done';
      task.result = { created: Date.now(), data: [{ url: videoUrl }] };
    })
    .catch((err) => {
      task.status = 'error';
      task.error = err.message;
    });
});
```

#### 3.2.2 GET /api/task/:taskId

```javascript
app.get('/api/task/:taskId', (req, res) => {
  const task = tasks.get(req.params.taskId);
  if (!task) {
    return res.status(404).json({ error: '任务不存在' });
  }

  const elapsed = Math.floor((Date.now() - task.startTime) / 1000);

  if (task.status === 'done') {
    res.json({ status: 'done', elapsed, result: task.result });
    setTimeout(() => tasks.delete(task.id), 300000); // 5分钟后删除
    return;
  }

  if (task.status === 'error') {
    res.json({ status: 'error', elapsed, error: task.error });
    setTimeout(() => tasks.delete(task.id), 300000);
    return;
  }

  res.json({ status: 'processing', elapsed, progress: task.progress });
});
```

#### 3.2.3 GET /api/video-proxy

```javascript
app.get('/api/video-proxy', async (req, res) => {
  const videoUrl = req.query.url;
  if (!videoUrl) {
    return res.status(400).json({ error: '缺少 url 参数' });
  }

  const response = await fetch(videoUrl, {
    headers: {
      'User-Agent': FAKE_HEADERS['User-Agent'],
      Referer: 'https://jimeng.jianying.com/',
    },
  });

  // 转发响应头
  const contentType = response.headers.get('content-type');
  if (contentType) res.setHeader('Content-Type', contentType);
  res.setHeader('Accept-Ranges', 'bytes');
  res.setHeader('Cache-Control', 'public, max-age=3600');

  // 流式转发
  const reader = response.body.getReader();
  const pump = async () => {
    while (true) {
      const { done, value } = await reader.read();
      if (done) { res.end(); return; }
      if (!res.write(value)) {
        await new Promise((r) => res.once('drain', r));
      }
    }
  };
  pump();
});
```

### 3.3 即梦API 封装

#### 3.3.1 工具函数

```javascript
// 生成UUID
function generateUUID() {
  return crypto.randomUUID();
}

// Unix时间戳
function unixTimestamp() {
  return Math.floor(Date.now() / 1000);
}

// MD5哈希
function md5(value) {
  return crypto.createHash('md5').update(value).digest('hex');
}

// 生成Cookie
function generateCookie(sessionId) {
  return [
    `_tea_web_id=${WEB_ID}`,
    `sessionid=${sessionId}`,
    // ...其他cookie
  ].join('; ');
}

// 生成签名
function generateSign(uri) {
  const deviceTime = unixTimestamp();
  const sign = md5(`9e2c|${uri.slice(-7)}|${PLATFORM_CODE}|${VERSION_CODE}|${deviceTime}||11ac`);
  return { deviceTime, sign };
}
```

#### 3.3.2 jimengRequest - 统一请求函数

```javascript
async function jimengRequest(method, uri, sessionId, options = {}) {
  const { deviceTime, sign } = generateSign(uri);
  const fullUrl = new URL(`${JIMENG_BASE_URL}${uri}`);

  // 添加默认参数
  const defaultParams = {
    aid: DEFAULT_ASSISTANT_ID,
    device_platform: 'web',
    // ...
  };

  const headers = {
    ...FAKE_HEADERS,
    Cookie: generateCookie(sessionId),
    'Device-Time': String(deviceTime),
    Sign: sign,
  };

  // 重试机制 (最多3次)
  for (let attempt = 0; attempt <= 3; attempt++) {
    try {
      const response = await fetch(fullUrl.toString(), {
        method,
        headers,
        body: options.data ? JSON.stringify(options.data) : undefined,
        signal: AbortSignal.timeout(45000),
      });
      const data = await response.json();

      if (String(data.ret) === '0') return data.data;
      if (String(data.ret) === '5000') throw new Error('即梦积分不足');
      throw new Error(`即梦API错误: ${data.errmsg}`);
    } catch (err) {
      if (attempt === 3) throw err;
      await new Promise(r => setTimeout(r, 1000 * attempt));
    }
  }
}
```

### 3.4 图片上传流程

#### 3.4.1 uploadImageBuffer 函数

```javascript
async function uploadImageBuffer(buffer, sessionId) {
  // 第1步: 获取上传令牌
  const tokenResult = await jimengRequest(
    'post',
    '/mweb/v1/get_upload_token',
    sessionId,
    { data: { scene: 2 } }
  );
  const { access_key_id, secret_access_key, session_token, service_id } = tokenResult;

  // 第2步: 申请上传权限
  const applyUrl = `https://imagex.bytedanceapi.com/?Action=ApplyImageUpload&...`;
  const authorization = createAWSSignature('GET', applyUrl, ...);
  const applyResponse = await fetch(applyUrl, { headers: { authorization } });
  const applyResult = await applyResponse.json();
  const uploadAddress = applyResult.Result.UploadAddress;

  // 第3步: 上传图片文件
  const uploadUrl = `https://${uploadHost}/upload/v1/${storeUri}`;
  await fetch(uploadUrl, {
    method: 'POST',
    headers: {
      Authorization: storeInfo.Auth,
      'Content-CRC32': crc32,
      'Content-Type': 'application/octet-stream',
    },
    body: buffer,
  });

  // 第4步: 提交上传
  const commitUrl = `https://imagex.bytedanceapi.com/?Action=CommitImageUpload&...`;
  const commitResult = await fetch(commitUrl, {
    method: 'POST',
    headers: { authorization: commitAuth },
    body: JSON.stringify({ SessionKey: uploadAddress.SessionKey }),
  });

  return commitResult.Result.Results[0].Uri;
}
```

#### 3.4.2 AWS4-HMAC-SHA256 签名

```javascript
function createAWSSignature(method, url, headers, accessKeyId, secretAccessKey, sessionToken, payload) {
  const timestamp = headers['x-amz-date'];
  const date = timestamp.substr(0, 8);
  const region = 'cn-north-1';
  const service = 'imagex';

  // 构建规范化请求
  const canonicalRequest = [
    method.toUpperCase(),
    pathname,
    canonicalQueryString,
    canonicalHeaders,
    signedHeaders,
    payloadHash,
  ].join('\n');

  // 构建待签名字符串
  const credentialScope = `${date}/${region}/${service}/aws4_request`;
  const stringToSign = [
    'AWS4-HMAC-SHA256',
    timestamp,
    credentialScope,
    sha256(canonicalRequest),
  ].join('\n');

  // 计算签名
  const kDate = hmacSha256(`AWS4${secretAccessKey}`, date);
  const kRegion = hmacSha256(kDate, region);
  const kService = hmacSha256(kRegion, service);
  const kSigning = hmacSha256(kService, 'aws4_request');
  const signature = hmacSha256(kSigning, stringToSign);

  return `AWS4-HMAC-SHA256 Credential=${accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
}
```

### 3.5 视频生成流程

#### 3.5.1 generateSeedanceVideo 函数

```javascript
async function generateSeedanceVideo(taskId, { prompt, ratio, duration, files, sessionId }) {
  // 第1步: 上传所有图片
  const uploadedImages = [];
  for (let i = 0; i < files.length; i++) {
    task.progress = `正在上传第 ${i + 1}/${files.length} 张图片...`;
    const imageUri = await uploadImageBuffer(files[i].buffer, sessionId);
    uploadedImages.push({ uri: imageUri, width, height });
  }

  // 第2步: 构建 material_list 和 meta_list
  const materialList = uploadedImages.map(img => ({
    type: '',
    id: generateUUID(),
    material_type: 'image',
    image_info: { image_uri: img.uri, width: img.width, height: img.height },
  }));

  const metaList = buildMetaListFromPrompt(prompt, uploadedImages.length);

  // 第3步: 提交生成请求
  task.progress = '正在提交视频生成请求...';
  const { aigc_data } = await jimengRequest(
    'post',
    '/mweb/v1/aigc_draft/generate',
    sessionId,
    {
      data: {
        extend: { root_model: SEEDANCE_MODEL, ... },
        submit_id: generateUUID(),
        draft_content: JSON.stringify({
          component_list: [{
            generate_type: 'gen_video',
            abilities: {
              gen_video: {
                text_to_video_params: {
                  video_gen_inputs: [{
                    duration_ms: duration * 1000,
                    unified_edit_input: {
                      material_list: materialList,
                      meta_list: metaList,
                    },
                  }],
                  video_aspect_ratio: aspectRatio,
                  model_req_key: SEEDANCE_MODEL,
                },
              }],
            },
          }],
        }),
      },
    }
  );

  const historyId = aigc_data?.history_record_id;

  // 第4步: 轮询获取结果
  let status = 20;
  for (let retry = 0; retry < 60 && status === 20; retry++) {
    const result = await jimengRequest(
      'post',
      '/mweb/v1/get_history_by_ids',
      sessionId,
      { data: { history_ids: [historyId] } }
    );

    status = result?.history_list?.[0]?.status;

    if (status === 30) {
      throw new Error('视频生成失败');
    }

    if (status === 20) {
      task.progress = 'AI正在生成视频...';
      await new Promise(r => setTimeout(r, 2000 * Math.min(retry + 1, 5)));
    }
  }

  // 第5步: 获取高清视频URL
  const hqResult = await jimengRequest(
    'post',
    '/mweb/v1/get_local_item_list',
    sessionId,
    { data: { item_id_list: [itemId] } }
  );

  return hqResult.item_list[0].video.download_url;
}
```

#### 3.5.2 buildMetaListFromPrompt - 解析提示词

```javascript
function buildMetaListFromPrompt(prompt, imageCount) {
  const metaList = [];
  const placeholderRegex = /@(?:图|image)?(\d+)/gi;
  let match;

  // 解析 @1, @2 等占位符
  while ((match = placeholderRegex.exec(prompt)) !== null) {
    const imageIndex = parseInt(match[1]) - 1;
    if (imageIndex >= 0 && imageIndex < imageCount) {
      metaList.push({
        meta_type: 'image',
        material_ref: { material_idx: imageIndex },
      });
    }
  }

  // 如果没有占位符，构建默认引用
  if (metaList.length === 0) {
    for (let i = 0; i < imageCount; i++) {
      metaList.push({ meta_type: 'image', material_ref: { material_idx: i } });
    }
    metaList.push({ meta_type: 'text', text: prompt });
  }

  return metaList;
}
```

## 4. 错误处理设计

### 4.1 前端错误处理

```typescript
try {
  const result = await generateVideo(request, onProgress);
  // 处理成功
} catch (error) {
  setGeneration({
    status: 'error',
    error: error instanceof Error ? error.message : '未知错误',
  });
}
```

### 4.2 后端错误处理

| 错误类型 | 处理方式 |
|----------|----------|
| 认证失败 | 返回 401，提示配置 SessionID |
| 参数错误 | 返回 400，说明具体问题 |
| 即梦API错误 | 转换为友好提示，如"积分不足" |
| 网络超时 | 自动重试3次，失败后抛出错误 |
| 内容过滤 | 返回错误，提示修改提示词 |

## 5. 配置管理

### 5.1 前端配置

```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
});
```

### 5.2 后端配置

```javascript
// 常量配置
const JIMENG_BASE_URL = 'https://jimeng.jianying.com';
const DEFAULT_ASSISTANT_ID = 513695;
const VERSION_CODE = '5.8.0';
const PLATFORM_CODE = '7';
const SEEDANCE_MODEL = 'dreamina_seedance_40_pro';

// 环境变量
const PORT = process.env.PORT || 3001;
const DEFAULT_SESSION_ID = process.env.VITE_DEFAULT_SESSION_ID || '';
```

## 6. 部署配置

### 6.1 开发环境启动

```bash
# 安装依赖
npm run install:all

# 启动开发服务
npm run dev
```

### 6.2 生产环境部署

```bash
# 构建
npm run build

# 启动生产服务
npm start
```

### 6.3 生产环境配置

```javascript
// server/index.js
if (process.env.NODE_ENV === 'production') {
  // 静态文件服务
  app.use(express.static(path.join(__dirname, '../dist')));

  // SPA 回退
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../dist/index.html'));
  });
}
```
